# Quick Start Guide

Get SMS/MMS in Linphone using your cellular number in 4 phases.

## Overview

**What you're building:**
```
VPS (Bridge) ← WireGuard VPN → Android (Home) ← Cellular → Your Number
     ↕                                  ↕
  Linphone                         Fossify API
```

**Key concept:** Android phone stays at home with your SIM. WireGuard VPN connects it to your VPS. Bridge routes messages between Linphone and cellular.

## Prerequisites

- VPS with Ubuntu 22.04, public IP
- Android phone (stays home, plugged in, connected to internet)
- Domain with DNS pointing to VPS
- VoIP.ms account (for voice calls & call forwarding only - NOT for SMS/MMS)

## Phase 0: WireGuard VPN ⭐ START HERE

**Why:** Android phone has no public IP and is behind NAT/firewall. WireGuard creates encrypted tunnel so VPS can reach phone.

### One-Command Setup

```bash
cd scripts/
./complete-setup.sh
```

This will:
1. Install WireGuard on VPS
2. Generate VPN keys
3. Create server config (VPS = 10.0.0.1)
4. Create client config (Android = 10.0.0.2)
5. Show QR code for Android
6. Setup bridge server

### Install on Android

1. Install WireGuard from Play Store
2. Tap "+" → "Scan from QR code"
3. Scan QR code from setup script
4. Toggle VPN ON
5. Verify: Should show "Active"

### Test VPN Connection

```bash
# From VPS
ping 10.0.0.2

# Should get replies from Android
```

**✓ Checkpoint:** VPS can ping Android at 10.0.0.2

## Phase 1: Build Fossify with API

**Why:** Fossify Messages uses native Android MMS APIs (full sending support). We add HTTP API so bridge can control it.

### Quick Path

See [../fossify-api/README.md](../fossify-api/README.md) for detailed instructions.

### Overview

1. Fork https://github.com/FossifyOrg/Messages
2. Add dependencies (NanoHTTPD, Gson)
3. Copy `fossify-api/*.kt` files to project
4. Build APK
5. Install on Android phone
6. Configure in app:
   - Settings → API Server → Enable ✓
   - Port: 8080
   - Generate auth token (save it!)
   - Webhook URL: `https://bridge.your-domain.com:5000/webhook/fossify`
   - Webhook token: (from bridge .env file)

### Test Fossify API

```bash
# From VPS (via WireGuard)
curl http://10.0.0.2:8080/health

# Should return:
{"status":"ok","server":"fossify-api"}
```

**✓ Checkpoint:** Fossify API responds via WireGuard VPN

## Phase 2: Deploy Bridge + mmsgate

**Why:** Bridge proxies VoIP.ms API calls. mmsgate converts between VoIP.ms API and SIP MESSAGE protocol that Linphone understands. Both run together in docker-compose on internal network.

### Automated Deployment

```bash
cd bridge-server/

# One command: clones mmsgate, builds images, pushes to registry, starts all services
../scripts/install-bridge.sh
```

This will:
1. Check Docker and docker-compose installed
2. Generate .env if needed (prompts for config)
3. Clone mmsgate repo (if missing)
4. Build mmsgate container (multi-layer process):
   - Layer 1: Flexisip base (SIP proxy)
   - Layer 2: PJSIP library
   - Layer 3: mmsgate final (includes flexisip + pjsip)
5. Push mmsgate image to local registry (port 5001)
6. Push sms-bridge image to registry
7. Start all services
8. Run health checks

**First run will take 30-40 minutes due to builds. Subsequent runs are fast (uses cached images).**

### Configuration

When prompted during install-bridge.sh:

```ini
# .env file
FOSSIFY_API_URL=http://10.0.0.2:8080        # Via WireGuard VPN
FOSSIFY_AUTH_TOKEN=<from Fossify settings>  # Your auth token
BRIDGE_SECRET=<auto-generated>              # Keep this secure
```

### Manual Setup (if needed)

```bash
cd bridge-server/

# Generate config
../scripts/generate-secrets.sh > .env

# Edit .env with Fossify settings
nano .env

# Build and push images to registry
../scripts/build-and-push-images.sh

# Start services
docker-compose up -d

# Check logs
docker-compose logs -f
```

### Services Running

- **sms-bridge**: Port 5000, Flask app, health check at `/health`
- **mmsgate**: Port 38443 (MMS), 5060/5061 (SIP via flexisip inside), 38000-38999 (RTP)
  - Includes flexisip SIP proxy (built-in, not separate service)
  - Routes SIP ↔ cellular
- **nginx**: Reverse proxy (configure for HTTPS)
- **registry**: Port 5001, local Docker image storage

**Note:** VoIP.ms credentials are NOT needed in the bridge. The bridge routes SMS/MMS directly to your cellular network via Fossify, bypassing VoIP.ms entirely.

**✓ Checkpoint:** Bridge can reach Fossify and proxy works

## Phase 3: Configure mmsgate

**Why:** Optional - SMS/MMS works immediately with placeholder credentials. Only needed if you want voice calls.

### Edit mmsgate.conf (Optional for Voice Calls)

```bash
cd bridge-server/
nano mmsgate.conf
```

**For SMS/MMS only:** Use placeholder values from [../configs/mmsgate.conf.example](../configs/mmsgate.conf.example)

**For voice calls:** Update with your actual VoIP provider credentials:

```ini
[voipms]
# CRITICAL: Point to bridge, not real VoIP.ms!
api_url = https://bridge.your-domain.com:5000/voipms/api
username = your_email@example.com        # Your VoIP provider account
password = your_password                  # Your VoIP provider password
did = 15551234567                         # Your VoIP provider DID (for calls)

[server]
listen = 0.0.0.0
port = 38443
cert_file = /etc/mmsgate/certs/fullchain.pem
key_file = /etc/mmsgate/certs/privkey.pem
```

### Restart mmsgate (Only if you edited the config)

```bash
cd bridge-server/
docker-compose restart mmsgate

# Check logs
docker-compose logs -f mmsgate
```

### Configure VoIP Provider Webhook (Only for Voice Calls)

If using voice calls with VoIP.ms:

1. Login to https://voip.ms
2. DID Numbers → Manage DIDs → Select your DID
3. SMS Settings:
   - Enable "Message Service (SMS/MMS)"
   - Enable "SMS/MMS Webhook URL"
   - URL: `https://mms.your-domain.com:38443/mmsgate`
   - Method: POST
4. Save

**✓ Checkpoint:** SMS/MMS works! (Optional: VoIP.ms webhook configured for voice)

## Phase 4: Setup Linphone (Optional for Voice Calls)

**Why:** SIP client for voice calls. SMS/MMS work without this step.

**Important:** SMS/MMS functionality is now complete! You can test messages without setting up Linphone.

### Install Linphone

- iOS: App Store
- Android: Play Store  
- Desktop: https://linphone.org

### Configure SIP Account

1. Open Linphone
2. Add SIP account:
   - **Username:** `your-sip-username` (you choose this)
   - **Password:** `your-sip-password` (you choose this)
   - **Domain:** `sip.your-domain.com` (your bridge domain)
   - **Transport:** TLS
   - **Save**

3. Should show "Registered" or green checkmark

### Test SMS/MMS

Send a text message in Linphone - it works immediately without any additional setup!

### (Optional) Enable Voice Calls

If using voice calls with a VoIP provider:

1. Configure your VoIP provider to forward calls to your SIP address
2. Example with VoIP.ms:
   - Dial `*72` + your VoIP DID to enable forwarding
   - Now calls to your cellular number ring in Linphone

Done! You now have SMS/MMS + voice in one app.

````

**✓ Checkpoint:** Linphone registered, calls forwarded

## End-to-End Testing

### Test 1: Send SMS from Linphone

1. Open Linphone
2. New message
3. To: Any phone number
4. Message: "Test from Linphone"
5. Send

**Expected:**
- mmsgate receives SIP MESSAGE
- mmsgate calls bridge `/voipms/api`
- Bridge routes to Fossify via WireGuard
- Fossify sends via cellular
- Recipient receives from YOUR cellular number

**Check logs:**
```bash
# Bridge
docker-compose logs -f bridge

# Should see: voipms/api called, forwarded to Fossify
```

### Test 2: Receive SMS

1. From another phone, text your cellular number
2. Message: "Reply test"

**Expected:**
- Fossify receives via cellular
- Fossify calls bridge webhook
- Bridge forwards to mmsgate
- mmsgate sends SIP MESSAGE
- Appears in Linphone

### Test 3: Send MMS

1. In Linphone, new message
2. Attach photo
3. Add text
4. Send

**Expected:**
- Photo sent via MMS
- Recipient receives from your cellular number

### Test 4: Receive MMS

1. Someone sends you photo via MMS
2. Should appear in Linphone with image

### Test 5: Voice Call

1. Call your cellular number
2. Should ring in Linphone
3. Answer

## Troubleshooting

### Messages not sending

```bash
# Check WireGuard
ping 10.0.0.2

# Check Fossify API
curl http://10.0.0.2:8080/health

# Check bridge logs
docker-compose logs bridge | grep ERROR
```

### Messages not receiving

```bash
# Check Fossify webhook
# Look in Android logs

# Check bridge received webhook
docker-compose logs bridge | grep fossify

# Check mmsgate
docker logs mmsgate
```

### WireGuard not connecting

```bash
# VPS side
sudo wg show
sudo systemctl status wg-quick@wg0

# Android side
# Check WireGuard app shows "Active"
# Try toggle off/on
```

See [docs/TROUBLESHOOTING.md](../docs/TROUBLESHOOTING.md) for more.

## Network Diagram

```
┌─────────────────┐
│   Linphone      │ ← You (traveling)
│  (anywhere)     │
└────────┬────────┘
         │ SIP/TLS
┌────────▼────────┐
│   VoIP.ms       │
│  SIP Server     │
└────────┬────────┘
         │
┌────────▼────────┐
│    mmsgate      │ ← Converts SIP ↔ VoIP.ms API
│  (on VPS)       │
└────────┬────────┘
         │ HTTP
┌────────▼────────┐
│  Bridge Server  │ ← Proxies VoIP.ms API calls
│  10.0.0.1 (VPN) │    Routes to Fossify
└────────┬────────┘
         │ WireGuard VPN (encrypted tunnel)
         │ 10.0.0.0/24
┌────────▼────────┐
│ Android Phone   │ ← Stays at home, plugged in
│ 10.0.0.2 (VPN)  │
│ Fossify API     │
└────────┬────────┘
         │ Cellular network
┌────────▼────────┐
│  Your Cellular  │
│  Number (SIM)   │
└─────────────────┘
```

## Security Checklist

- [x] WireGuard VPN encrypted (only VPS can reach Android)
- [x] Fossify API requires auth token
- [x] Bridge webhooks require auth token
- [x] HTTPS for all internet-facing endpoints
- [x] Firewall configured (only needed ports open)
- [x] Keys stored securely

## Performance Tips

### Reduce Latency

```ini
# WireGuard wg0.conf
[Peer]
PersistentKeepalive = 10  # More frequent keepalive
```

### Save Android Battery

```ini
[Peer]
PersistentKeepalive = 60  # Less frequent keepalive
```

### Keep Connection Alive

On Android:
- Settings → Apps → WireGuard → Battery → Unrestricted
- WireGuard app → Settings → Always-on VPN ✓

## Monthly Costs

- VPS: $1.50
- Cellular SIM + plan: $8.00
- VoIP.ms DID: $0.85
- Domain: Free (already own)
- **Total: ~$10.35/month**

Compare to international roaming: $50-100/month

## What You've Built

✅ Complete communications system
✅ Voice calls via VoIP in Linphone
✅ SMS via your cellular number in Linphone  
✅ MMS via your cellular number in Linphone
✅ Works anywhere with internet
✅ Secure (encrypted VPN)
✅ Cost-effective (~$30/month)

**Your cellular number stays active. You get everything in one app.**

## Next Steps

1. Test thoroughly
2. Setup monitoring and alerts
3. Configure backups
4. Document your specific config
5. Travel with confidence!

## Support

- [Architecture Details](ARCHITECTURE.md)
- [Fossify Build Guide](../fossify-api/README.md)
- [Troubleshooting](TROUBLESHOOTING.md)
